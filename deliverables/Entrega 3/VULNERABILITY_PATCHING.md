# Vulnerability Patching Report

## Herramientas de Escaneo

- **Trivy** v0.69.x — Scanner open-source de Aqua Security para vulnerabilidades en dependencias
- **npm audit** — Herramienta nativa de npm para auditar dependencias

## Resumen Before/After

| Metrica | Before | After | Diferencia |
|---------|--------|-------|------------|
| Total vulnerabilidades (HIGH+CRITICAL) | 44 | 42 | **-2** |
| CRITICAL | 9 | 8 | **-1** |
| HIGH | 35 | 34 | **-1** |

## Vulnerabilidades Parcheadas

### 1. crypto-js < 4.2.0 (via pdfkit) — CRITICAL

| Campo | Valor |
|-------|-------|
| **CVE** | CVE-2023-46233 |
| **Paquete afectado** | `crypto-js` 3.3.0 (dependencia transitiva de `pdfkit`) |
| **Severidad** | CRITICAL |
| **Descripcion** | PBKDF2 1,000 veces mas debil que lo especificado en 1993 y 1.3M veces mas debil que el estandar actual OWASP |
| **Advisory** | [GHSA-xwcq-pm8m-c4vf](https://github.com/advisories/GHSA-xwcq-pm8m-c4vf) |
| **Fix aplicado** | `npm install pdfkit@latest` (0.11.0 → 0.17.2) |
| **Archivo afectado** | `routes/order.ts` — generacion de PDFs de ordenes |
| **Impacto en challenges** | Ninguno — `pdfkit` no tiene marcadores `vuln-code-snippet` |

### 2. ws < 7.5.10 (via socket.io) — HIGH

| Campo | Valor |
|-------|-------|
| **CVE** | CVE-2024-37890 |
| **Paquete afectado** | `ws` 7.4.6 (dependencia transitiva de `socket.io` 3.1.x) |
| **Severidad** | HIGH |
| **Descripcion** | Denial of Service al manejar requests con muchos HTTP headers |
| **Advisory** | [GHSA-3h5v-q93c-6h6q](https://avd.aquasec.com/nvd/cve-2024-37890) |
| **Fix aplicado** | `npm install socket.io@^4.8.3` + `npm install --save-dev socket.io-client@^4.8.3` |
| **Archivos modificados** | `test/api/socketSpec.ts`, `test/api/vulnCodeFixesSpec.ts`, `test/api/vulnCodeSnippetSpec.ts`, `lib/challengeUtils.ts`, `lib/startup/registerWebsocketEvents.ts` |
| **Impacto en challenges** | Ninguno — cambios solo en tipos TypeScript e imports |

## Cambios Realizados en el Codigo

### pdfkit upgrade (0.11.0 → 0.17.2)
- `package.json`: version bump automatico via `npm install`
- `routes/order.ts`: sin cambios necesarios — la API de PDFDocument es retrocompatible

### socket.io upgrade (3.1.2 → 4.8.3)
- `package.json`: `socket.io` 3.1.2 → 4.8.3, `socket.io-client` 3.1.3 → 4.8.3
- Removido `@types/socket.io-client` (v4 incluye tipos built-in)
- `test/api/socketSpec.ts`: `import io from` → `import { io, type Socket } from`, tipo `SocketIOClient.Socket` → `Socket`
- `test/api/vulnCodeFixesSpec.ts`: import actualizado, tipo `SocketIOClient.Socket` → `ReturnType<typeof io>`
- `test/api/vulnCodeSnippetSpec.ts`: import actualizado, tipo `SocketIOClient.Socket` → `ReturnType<typeof io>`
- `lib/challengeUtils.ts`: tipo global `SocketIOClientStatic & Server` → `Server`
- `lib/startup/registerWebsocketEvents.ts`: tipo global simplificado, removido `@ts-expect-error` innecesario

## Vulnerabilidades NO Parcheadas (Intencionales)

Las siguientes vulnerabilidades son **intencionales** — son parte de los challenges de seguridad de OWASP Juice Shop y NO deben ser corregidas:

| Paquete | Version | Razon |
|---------|---------|-------|
| `jsonwebtoken` | 0.4.0 | Challenge de JWT bypass |
| `express-jwt` | 0.1.3 | Challenge de autorizacion |
| `sanitize-html` | 1.4.2 | Challenge de XSS |
| `marsdb` | 0.6.11 | Challenge de NoSQL injection |
| `vm2` | 3.9.17 | Challenge de sandbox escape |
| `lodash` | 2.4.2 | Dependencia transitiva de sanitize-html |
| `unzipper` | 0.9.15 | Challenge de path traversal |

## Reportes Completos

- [`vulnerability-scan/trivy-before.json`](vulnerability-scan/trivy-before.json) — Trivy JSON (pre-parcheo)
- [`vulnerability-scan/trivy-before.txt`](vulnerability-scan/trivy-before.txt) — Trivy tabla (pre-parcheo)
- [`vulnerability-scan/trivy-after.json`](vulnerability-scan/trivy-after.json) — Trivy JSON (post-parcheo)
- [`vulnerability-scan/trivy-after.txt`](vulnerability-scan/trivy-after.txt) — Trivy tabla (post-parcheo)
- [`vulnerability-scan/npm-audit-before.json`](vulnerability-scan/npm-audit-before.json) — npm audit JSON (pre-parcheo)
- [`vulnerability-scan/npm-audit-before.txt`](vulnerability-scan/npm-audit-before.txt) — npm audit texto (pre-parcheo)
- [`vulnerability-scan/npm-audit-after.json`](vulnerability-scan/npm-audit-after.json) — npm audit JSON (post-parcheo)
- [`vulnerability-scan/npm-audit-after.txt`](vulnerability-scan/npm-audit-after.txt) — npm audit texto (post-parcheo)

## Verificacion

```bash
# Verificar compilacion TypeScript
npx tsc --noEmit

# Verificar versions instaladas
npm ls pdfkit socket.io socket.io-client

# Ejecutar escaneo actual
trivy fs --severity HIGH,CRITICAL --scanners vuln .
```
