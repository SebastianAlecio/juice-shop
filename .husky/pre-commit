#!/usr/bin/env sh

echo "Running secret detection on staged files..."

# Get list of staged files (excluding deleted files), null-separated for safe handling
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files to check."
  exit 0
fi

# Run secretlint on staged files (using null separator to handle spaces in paths)
git diff --cached --name-only -z --diff-filter=d | xargs -0 npx secretlint

if [ $? -ne 0 ]; then
  echo ""
  echo "ERROR: Secrets detected in staged files!"
  echo "Please remove the secrets before committing."
  echo "If this is a false positive, add an inline ignore comment."
  exit 1
fi

echo "No secrets detected. Proceeding with commit."
